<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>Crave Tracker</title>

	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/semantic.min.css">

	<script src="libs/jquery.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
	<script src="libs/moment.js"></script>
	<script src="libs/localforage.min.js"></script>
	<script src="libs/Semantic-UI-CSS/semantic.min.js"></script>

	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/reset.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/site.css">

	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/container.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/grid.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/header.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/image.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/menu.css">

	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/divider.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/list.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/segment.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/dropdown.css">
	<link rel="stylesheet" type="text/css" href="libs/Semantic-UI-CSS/components/icon.css">

	<style type="text/css">
		body {
			background-color: #FFFFFF;
		}
		
		.ui.menu .item img.logo {
			margin-right: 1.5em;
		}
		
		.main.container {
			margin-top: 1em;
		}
		
		.wireframe {
			margin-top: 2em;
		}
		
		.ui.footer.segment {
			margin: 5em 0em 0em;
			padding: 5em 0em;
		}
	</style>

</head>

<body>

	<div class="ui main text container">
		<h1 class="ui header">Crave Tracker</h1>
		<p>Keep track of your your cravings.</p>

		<h4 class="ui horizontal divider header">
  		<i class="edit icon"></i>
		  Entry
		</h4>

		<div class="ui form">

			<div class="field">
				<label class="ui top attached label">Description</label>
				<textarea id="in-description"></textarea>
			</div>

			<div class="field">
				<label>When</label>
				<div class="ui icon buttons large">
					<div id="btn-set-time-now" class="ui icon button">
						<i class="time icon"></i>
					</div>
					<div id="in-hour" class="ui dropdown button compact">
						<span class="text">Select Hour</span>
						<div class="menu">
							<div data-value="0" class="item">0 am</div>
							<div data-value="1" class="item">1</div>
							<div data-value="2" class="item">2</div>
							<div data-value="3" class="item">3</div>
							<div data-value="4" class="item">4</div>
							<div data-value="5" class="item">5</div>
							<div data-value="6" class="item">6</div>
							<div data-value="7" class="item">7</div>
							<div data-value="8" class="item">8</div>
							<div data-value="9" class="item">9</div>
							<div data-value="10" class="item">10</div>
							<div data-value="11" class="item">11</div>
							<div class="ui divider"></div>
							<div data-value="12" class="item">12pm</div>
							<div data-value="13" class="item">13</div>
							<div data-value="14" class="item">14</div>
							<div data-value="15" class="item">15</div>
							<div data-value="16" class="item">16</div>
							<div data-value="17" class="item">17</div>
							<div data-value="18" class="item">18</div>
							<div data-value="19" class="item">19</div>
							<div data-value="20" class="item">20</div>
							<div data-value="21" class="item">21</div>
							<div data-value="22" class="item">22</div>
							<div data-value="23" class="item">23</div>
						</div>
					</div>
					<div id="in-minute" class="ui dropdown  button narrow">
						<span class="text">Select Minute</span>
						<div class="menu">
							<div class="item">:00</div>
							<div class="item">:05</div>
							<div class="item">:10</div>
							<div class="item">:15</div>
							<div class="item">:20</div>
							<div class="item">:25</div>
							<div class="item">:30</div>
							<div class="item">:35</div>
							<div class="item">:40</div>
							<div class="item">:45</div>
							<div class="item">:50</div>
							<div class="item">:55</div>
						</div>
					</div>
				</div>
			</div>

			<div class="field">
				<label>Intensity</label>
				<div id="crave-level-bar" class="ui top attached progress">
					<div class="bar"></div>
				</div>
				<div id="crave-level" class="ui five item menu fitted" style="margin-top:0;">
					<a class="item">Weak</a>
					<a class="item">Mild</a>
					<a class="active item">Average</a>
					<a class="item">Strong</a>
					<a class="item">Intense</a>
				</div>
			</div>

			<div class="field">
				<label>Title</label>
				<div class="ui fluid action input">
					<input placeholder="Event" type="text" id="in-title" />
					<div class="ui button" id="btn-mark-event">
						<i class="save icon"></i> Save
					</div>
				</div>
			</div>

		</div>

		<br/>
		<h4 class="ui horizontal divider header">
  <i class="bar chart icon"></i>
  History
</h4>
		<div class="ui feed" id="event-list"></div>
		<div class="ui fluid button" id="btn-clear-all">
			<i class="trash icon"></i> Clear All
		</div>
		<br/>
	</div>

</body>

<script src="libs/moment.js"></script>
<script src="libs/localforage.min.js"></script>
<script>
	$(function() {
		$('#in-hour').dropdown();
		$('#in-minute').dropdown();
		$('#crave-level').on('click', 'a.item.active', function() {
			// already active
		});
		$('#crave-level-bar').progress({
			percent: 50
		});
		$('#crave-level').on('click', 'a.item', function() {
			$(this).parent().find('.active').removeClass('active');
			$(this).addClass('active');
			var progress = 100.0 * $(this).index() / ($(this).parent().children().length - 1);
			$(this).parent().parent().find('.progress').progress({
				percent: progress,
				autoSuccess: false
			});
		});
		$('#btn-set-time-now').on('click', function() {
			var time = new Date();
			var hr = time.getHours(); // 0-23
			var mn = 5 * Math.round(time.getMinutes() / 5); //0-59
			if (mn === 60) {
				mn = 55;
			}
			if (mn < 10) {
				mn = '0' + mn;
			}
			$('#in-hour').dropdown('set exactly', [hr]);
			$('#in-minute').dropdown('set exactly', [':' + mn]);
		}).trigger('click');
	});

	function readTitle() {
		return $('#in-title').val();
	}

	function readDescription() {
		return $('#in-description').val();
	}

	function readCraveBar() {
		var $bar = $('#crave-level');
		var $active = $bar.find('.active');
		return $active.index() / ($bar.children().length - 1);
	}

	function readTime() {
		var hour = parseInt($('#in-hour').dropdown('get value'));
		var minute = parseInt($('#in-minute').dropdown('get value').replace(':', ''));
		var time = (new Date());
		time.setHours(hour);
		time.setMinutes(minute);
		return time.getTime()
	}

	function readEvent() {
		return {
			title: readTitle(),
			description: readDescription(),
			level: readCraveBar(),
			time: readTime()
		};
	}

	function makeEventHtml(event) {
		return [
			'<div class="event">',
			'	<div class="label">',
			'<a class="ui red circular label large">' + event.level + '</a>',
			'	</div>',
			'	<div class="content">',
			'	  <div class="summary">',
			event.title,
			'		<div class="date">',
			moment(event.time).fromNow(),
			'		</div>',
			'	  </div>',
			'   <div class="extra text">',
			event.description,
			'   </div>',
			'	</div>',
			'</div>'
		].join('\n');
	}

	function drawTimes(value) {
		if (!value) {
			document.getElementById('event-list').innerHTML = '<p>No data points</p>';
		} else {
			console.info(value);
			var strings = [];
			value.sort(function(a, b) {
				return b.time - a.time;
			});
			for (var i = 0, l = value.length; i < l; i += 1) {
				strings.push(makeEventHtml(value[i]));
			}
			var output = '<p>' + strings.join('</p><p>') + '</p>';
			document.getElementById('event-list').innerHTML = output;
		}
	}

	function storeEvent(event) {
		return localforage.getItem('events').then(function(value) {
			if (!value) {
				value = [];
			}
			value.push(event);
			return localforage.setItem('events', value);
		});
	}

	localforage.setDriver(localforage.LOCALSTORAGE).then(function() {
		return localforage.getItem('events');
	}).then(drawTimes);

	document.getElementById('btn-clear-all').addEventListener('click', function() {
		localforage.removeItem('events').then(drawTimes);
	});

	document.getElementById('btn-mark-event').addEventListener('click', function() {
		storeEvent(
			readEvent()
		).then(drawTimes);
	});
</script>

</html>
